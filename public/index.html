<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rummy Multiplayer</title>

<style>
body {
    margin:0;
    font-family:Arial;
    background:#1e3c72;
}
.screen { display:none; padding:20px; }
.active { display:block; }

.card {
    width:50px;
    height:70px;
    border:2px solid black;
    border-radius:6px;
    background:white;
    display:inline-flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;
    margin:3px;
    cursor:pointer;
}
.card.red { color:red; }
.card.selected {
    border:3px solid gold;
    transform:translateY(-5px);
}
button { padding:8px 12px; margin:5px; }
</style>
</head>

<body>

<div id="lobby" class="screen active">
    <h2>ðŸŽ´ Rummy Game</h2>
    <input id="name" placeholder="Your Name"><br>
    <button onclick="createRoom()">Create Room</button>
    <button onclick="joinRoom()">Join Room</button>
    <input id="roomCode" placeholder="Room Code">
</div>

<div id="waiting" class="screen">
    <h3>Room: <span id="roomDisplay"></span></h3>
    <div id="players"></div>
    <button onclick="startGame()">Start Game</button>
</div>

<div id="game" class="screen">
    <h3>Room: <span id="gameRoom"></span></h3>
    <div id="turnInfo"></div>

    <h4>Discard Pile</h4>
    <div id="discardPile"></div>

    <h4>Your Cards (<span id="cardCount"></span>)</h4>
    <div id="hand"></div>

    <button onclick="drawCard('deck')">Draw Deck</button>
    <button onclick="drawCard('discard')">Draw Discard</button>
    <button onclick="discardSelected()">Discard</button>
    <button onclick="declareShow()">Show</button>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();

let currentRoom=null;
let myId=null;
let gameState=null;
let selected=[];

/* ---------- UI ---------- */

function show(id){
    document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
    document.getElementById(id).classList.add("active");
}

/* ---------- ROOM ---------- */

function createRoom(){
    const name=document.getElementById("name").value;
    socket.emit("createRoom",{playerName:name});
}

function joinRoom(){
    const name=document.getElementById("name").value;
    const code=document.getElementById("roomCode").value;
    socket.emit("joinRoom",{playerName:name,roomCode:code});
}

function startGame(){
    socket.emit("startGame",{roomCode:currentRoom});
}

/* ---------- GAME ---------- */

function drawCard(source){
    socket.emit("drawCard",{roomCode:currentRoom,source});
}

/* ---- FIXED DISCARD (BY CARD ID) ---- */

function discardSelected(){
    if(selected.length!==1) return alert("Select 1 card");

    socket.emit("discardCard",{
        roomCode:currentRoom,
        cardId:selected[0]
    });

    selected=[];
}

/* ---------- SHOW ---------- */

function declareShow(){

    const groups = [];
    const ungrouped = [];

    gameState.hand.forEach(card=>{
        if(selected.includes(card.id))
            groups.push([card]);
        else
            ungrouped.push(card);
    });

    socket.emit("declareWin",{
        roomCode:currentRoom,
        groups,
        ungrouped
    });
}

/* ---------- RENDER ---------- */

function render(){
    if(!gameState) return;

    document.getElementById("turnInfo").innerText =
        gameState.currentTurn===myId ? "YOUR TURN" : "Waiting...";

    document.getElementById("cardCount").innerText =
        gameState.hand.length;

    /* Render Hand */
    const handDiv=document.getElementById("hand");
    handDiv.innerHTML="";
    gameState.hand.forEach(card=>{
        const div=document.createElement("div");
        div.className="card";
        if(card.suit==="â™¥"||card.suit==="â™¦")
            div.classList.add("red");

        if(selected.includes(card.id))
            div.classList.add("selected");

        div.innerHTML=`<div>${card.value}</div><div>${card.suit}</div>`;

        div.onclick=()=>{
            if(selected.includes(card.id))
                selected=selected.filter(id=>id!==card.id);
            else
                selected.push(card.id);
            render();
        };

        handDiv.appendChild(div);
    });

    /* Discard */
    const discardDiv=document.getElementById("discardPile");
    discardDiv.innerHTML="";
    const top=gameState.discardPile.slice(-1)[0];
    if(top){
        discardDiv.innerHTML=`${top.value} ${top.suit}`;
    }
}

/* ---------- SOCKET ---------- */

socket.on("roomCreated",data=>{
    currentRoom=data.roomCode;
    myId=socket.id;
    document.getElementById("roomDisplay").innerText=currentRoom;
    show("waiting");
});

socket.on("roomJoined",data=>{
    currentRoom=data.roomCode;
    myId=socket.id;
    document.getElementById("roomDisplay").innerText=currentRoom;
    show("waiting");
});

socket.on("roomUpdate",room=>{
    const div=document.getElementById("players");
    div.innerHTML="";
    room.players.forEach(p=>{
        div.innerHTML+=`<div>${p.name}</div>`;
    });
});

socket.on("gameStarted",state=>{
    gameState=state;
    document.getElementById("gameRoom").innerText=currentRoom;
    show("game");
    render();
});

socket.on("gameState",state=>{
    gameState=state;
    render();
});

socket.on("roundWon",data=>{
    alert(data.winner+" WON! "+data.reason);
});

socket.on("wrongShow",data=>{
    alert("Wrong Show: "+data.reason);
});

socket.on("error",msg=>{
    alert(msg);
});
</script>

</body>
</html>
