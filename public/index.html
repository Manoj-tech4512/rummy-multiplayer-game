<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Rummy Game</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #1e3c72;
  margin: 0;
}
.screen { display: none; }
.screen.active { display: block; }
.lobby-container {
  background: #fff;
  max-width: 400px;
  margin: 50px auto;
  padding: 20px;
  border-radius: 10px;
}
button {
  width: 100%;
  padding: 10px;
  margin-top: 10px;
  font-size: 16px;
}
input {
  width: 100%;
  padding: 10px;
  margin-top: 10px;
}
#playersList div {
  padding: 6px;
  border-bottom: 1px solid #ddd;
}
.card {
  display: inline-block;
  padding: 6px 10px;
  margin: 4px;
  border: 1px solid #333;
  border-radius: 6px;
  background: #f4f4f4;
}
.message {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: black;
  color: white;
  padding: 10px 20px;
  border-radius: 6px;
}
.message.success { background: green; }
.message.error { background: red; }
</style>
</head>

<body>

<!-- LOBBY -->
<div id="lobbyScreen" class="screen active">
  <div class="lobby-container">
    <h2>ðŸŽ´ Rummy Game</h2>
    <input id="playerName" placeholder="Enter your name" />
    <button onclick="createRoom()">Create Room</button>
    <button onclick="showJoinRoom()">Join Room</button>

    <div id="joinRoomDiv" style="display:none">
      <input id="roomCode" placeholder="Room Code" />
      <button onclick="joinRoom()">Join</button>
    </div>
  </div>
</div>

<!-- WAITING -->
<div id="waitingScreen" class="screen">
  <div class="lobby-container">
    <h3>Room Code: <span id="displayRoomCode"></span></h3>
    <p>Share this code with friends</p>
    <div id="playersList"></div>
    <button id="startGameBtn" onclick="startGame()" style="display:none">
      Start Game
    </button>
    <button onclick="leaveRoom()">Leave Room</button>
  </div>
</div>

<!-- GAME -->
<div id="gameScreen" class="screen">
  <div class="lobby-container">
    <h3>ðŸŽ´ Game Started</h3>
    <p>Room: <span id="gameRoomCode"></span></p>

    <p id="turnInfo"></p>

    <h4>Players</h4>
    <div id="players"></div>

    <h4>Your Hand</h4>
    <div id="hand"></div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();

let currentRoom = null;
let myPlayerId = null;
let gameState = null;

/* UI HELPERS */
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function showMessage(text, type='info') {
  const m = document.createElement('div');
  m.className = 'message ' + type;
  m.textContent = text;
  document.body.appendChild(m);
  setTimeout(()=>m.remove(), 3000);
}

/* ROOM ACTIONS */
function createRoom() {
  const name = playerName.value.trim();
  if (!name) return showMessage('Enter name','error');
  socket.emit('createRoom', { playerName: name });
}

function showJoinRoom() {
  joinRoomDiv.style.display = 'block';
}

function joinRoom() {
  const name = playerName.value.trim();
  const code = roomCode.value.trim().toUpperCase();
  if (!name || !code) return showMessage('Enter name & code','error');
  socket.emit('joinRoom', { roomCode: code, playerName: name });
}

function startGame() {
  socket.emit('startGame', { roomCode: currentRoom });
}

function leaveRoom() {
  socket.emit('leaveRoom', { roomCode: currentRoom });
  currentRoom = null;
  showScreen('lobbyScreen');
}

/* SOCKET EVENTS */
socket.on('roomCreated', ({ roomCode, room }) => {
  currentRoom = roomCode;
  myPlayerId = socket.id;
  displayRoomCode.textContent = roomCode;
  gameRoomCode.textContent = roomCode;
  updatePlayers(room);
  showScreen('waitingScreen');
  showMessage('Room created','success');
});

socket.on('roomJoined', ({ roomCode, room }) => {
  currentRoom = roomCode;
  myPlayerId = socket.id;
  displayRoomCode.textContent = roomCode;
  gameRoomCode.textContent = roomCode;
  updatePlayers(room);
  showScreen('waitingScreen');
  showMessage('Joined room','success');
});

socket.on('roomUpdate', room => {
  updatePlayers(room);
});

/* ðŸ”¥ GAME STARTED */
socket.on('gameStarted', (state) => {
  console.log('ðŸŽ´ gameStarted', state);
  gameState = state;
  showScreen('gameScreen');
  renderGame();
});

/* ðŸ”¥ GAME STATE UPDATES (VERY IMPORTANT) */
socket.on('gameState', (state) => {
  console.log('ðŸ”„ gameState update', state);
  gameState = state;
  renderGame();
});

/* RENDER GAME */
function renderGame() {
  if (!gameState) return;

  // Turn info
  turnInfo.textContent =
    gameState.currentTurn === socket.id ? 'Your Turn' : 'Waiting for opponent...';

  // Players
  players.innerHTML = '';
  gameState.players.forEach(p => {
    const d = document.createElement('div');
    d.textContent = `${p.name} (${p.cardCount} cards)`;
    players.appendChild(d);
  });

  // Hand
  hand.innerHTML = '';
  gameState.hand.forEach(card => {
    const c = document.createElement('div');
    c.className = 'card';
    c.textContent = card.value + card.suit;
    hand.appendChild(c);
  });
}

/* PLAYERS LIST (WAITING SCREEN) */
function updatePlayers(room) {
  playersList.innerHTML = '';
  room.players.forEach(p => {
    const d = document.createElement('div');
    d.textContent = p.name + (p.id === room.host ? ' (Host)' : '');
    playersList.appendChild(d);
  });
  startGameBtn.style.display = room.host === socket.id ? 'block' : 'none';
}
</script>

</body>
</html>
