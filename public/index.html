<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Casino Indian Rummy</title>

<style>
body{
    margin:0;
    font-family:Arial, Helvetica, sans-serif;
    background:#063d06;
    overflow:hidden;
    color:white;
}

.screen{display:none;height:100vh;width:100vw}
.active{display:block}

/* Casino Table */
#table{
    position:relative;
    width:100%;
    height:100%;
    background:radial-gradient(circle at center,#0f5c0f,#063d06 70%);
}

#table::before{
    content:"";
    position:absolute;
    top:50%;
    left:50%;
    width:85%;
    height:60%;
    transform:translate(-50%,-50%);
    background:#0c4a0c;
    border-radius:50%;
    box-shadow:0 0 40px black inset;
}

/* Players */
.player{
    position:absolute;
    width:120px;
    padding:6px;
    background:rgba(0,0,0,0.7);
    border-radius:12px;
    text-align:center;
    font-size:12px;
}
.current-turn{border:2px solid gold}

/* Positions */
.p1{bottom:15px;left:50%;transform:translateX(-50%)}
.p2{top:15px;left:50%;transform:translateX(-50%)}
.p3{left:10px;top:50%;transform:translateY(-50%)}
.p4{right:10px;top:50%;transform:translateY(-50%)}
.p5{top:18%;left:20%}
.p6{top:18%;right:20%}

/* Center */
#center{
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    text-align:center;
    z-index:10;
}

button{
    padding:8px 14px;
    margin:5px;
    border-radius:8px;
    border:none;
    font-weight:bold;
    cursor:pointer;
    background:#ffd700;
}

#discard{font-size:28px;margin-bottom:10px}
#wildJoker{color:yellow;margin-bottom:10px}

/* Hand */
#hand{
    position:absolute;
    bottom:0;
    width:100%;
    background:rgba(0,0,0,0.85);
    padding:10px;
    display:flex;
    flex-wrap:wrap;
    justify-content:center;
    max-height:180px;
    overflow-y:auto;
}

/* Cards */
.card{
    width:45px;
    height:65px;
    background:white;
    border-radius:8px;
    border:2px solid black;
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;
    margin:5px;
    color:black;
    font-weight:bold;
    font-size:14px;
}
.card.red{color:red}
.card.selected{
    border:3px solid gold;
    transform:translateY(-5px);
}
.card.joker{
    border:3px solid purple;
    background:#ffe6ff;
}

#timer{
    position:absolute;
    top:10px;
    right:20px;
    font-size:18px;
    color:yellow;
}
</style>
</head>

<body>

<div id="game" class="screen active">
<div id="table">

<div id="timer"></div>
<div id="playersArea"></div>

<div id="center">
    <div id="wildJoker"></div>
    <div id="discard"></div>

    <button onclick="drawCard('deck')">Draw Deck</button>
    <button onclick="drawCard('discard')">Draw Discard</button>
    <button onclick="discardSelected()">Discard</button>
    <button onclick="createGroup()">Group</button>
    <button onclick="ungroup()">Ungroup</button>
    <button onclick="declareShow()">Show</button>
</div>

<div id="hand"></div>

</div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>

const socket = io();
let gameState=null;
let selected=[];
let groups=[];
let timerInterval;

/* Draw */
function drawCard(source){
    socket.emit("drawCard",{roomCode:gameState.roomCode,source});
}

/* Discard */
function discardSelected(){
    if(selected.length!==1){
        alert("Select 1 card");
        return;
    }
    socket.emit("discardCard",{
        roomCode:gameState.roomCode,
        cardId:selected[0]
    });
    selected=[];
}

/* Group */
function createGroup(){
    if(selected.length<3){
        alert("Select minimum 3 cards");
        return;
    }
    groups.push([...selected]);
    selected=[];
    render();
}

/* Ungroup */
function ungroup(){
    if(selected.length===0){
        alert("Select cards to ungroup");
        return;
    }

    groups = groups.map(group =>
        group.filter(id => !selected.includes(id))
    ).filter(group => group.length>=2);

    selected=[];
    render();
}

/* Show */
function declareShow(){

    const groupedCards=[];
    groups.forEach(g=>{
        groupedCards.push(
            g.map(id=>gameState.hand.find(c=>c.id===id))
        );
    });

    const groupedIds=groups.flat();
    const ungrouped=gameState.hand.filter(
        c=>!groupedIds.includes(c.id)
    );

    socket.emit("declareWin",{
        roomCode:gameState.roomCode,
        groups:groupedCards,
        ungrouped
    });
}

/* Render */
function render(){
    if(!gameState) return;

    /* Players */
    const area=document.getElementById("playersArea");
    area.innerHTML="";
    gameState.players.forEach((p,i)=>{
        const div=document.createElement("div");
        div.className="player p"+(i+1);
        if(p.id===gameState.currentTurn)
            div.classList.add("current-turn");

        div.innerHTML=`
            <div>${p.name}</div>
            <div>Cards: ${p.cardCount}</div>
            <div>Score: ${p.totalScore}</div>
        `;
        area.appendChild(div);
    });

    /* Wild Joker */
    if(gameState.cutJoker){
        document.getElementById("wildJoker").innerHTML=
            "Wild Joker: "+gameState.cutJoker.value+" "+gameState.cutJoker.suit;
    }

    /* Discard */
    const top=gameState.discardPile.slice(-1)[0];
    if(top){
        document.getElementById("discard").innerHTML=
            top.value+" "+top.suit;
    }

    /* Hand */
    const hand=document.getElementById("hand");
    hand.innerHTML="";

    gameState.hand.forEach(card=>{
        const div=document.createElement("div");
        div.className="card";

        if(card.suit==="♥"||card.suit==="♦")
            div.classList.add("red");

        if(card.value==="JOKER" ||
           card.value===gameState.cutJoker.value){
            div.classList.add("joker");
        }

        if(selected.includes(card.id))
            div.classList.add("selected");

        div.innerHTML=card.value+"<br>"+card.suit;

        div.onclick=()=>{
            if(selected.includes(card.id))
                selected=selected.filter(id=>id!==card.id);
            else
                selected.push(card.id);
            render();
        };

        hand.appendChild(div);
    });
}

/* Timer */
socket.on("timerStarted",()=>{
    let time=45;
    clearInterval(timerInterval);
    document.getElementById("timer").innerText="Time: 45";

    timerInterval=setInterval(()=>{
        time--;
        document.getElementById("timer").innerText="Time: "+time;
        if(time<=0) clearInterval(timerInterval);
    },1000);
});

socket.on("gameState",state=>{
    gameState=state;
    render();
});

socket.on("wrongShow",d=>alert("Wrong Show by "+d.player));
socket.on("roundWon",d=>alert("Winner: "+d.winner));

</script>
</body>
</html>
