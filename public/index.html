<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>6 Player Indian Rummy</title>

<style>
body {
    margin:0;
    font-family: Arial;
    background:#1e3c72;
    color:white;
    overflow:hidden;
}
.screen { display:none; padding:20px; }
.active { display:block; }

button {
    padding:8px 14px;
    margin:5px;
    border:none;
    border-radius:6px;
    cursor:pointer;
}

.card {
    width:50px;
    height:70px;
    background:white;
    border-radius:6px;
    border:2px solid black;
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;
    margin:4px;
    cursor:pointer;
    color:black;
    font-weight:bold;
}
.card.red { color:red; }
.card.selected {
    border:3px solid gold;
    transform:translateY(-6px);
}

#hand {
    display:flex;
    flex-wrap:wrap;
    max-height:200px;
    overflow-y:auto;
}

.player-box {
    background:rgba(255,255,255,0.15);
    padding:8px;
    border-radius:8px;
    margin:4px;
    font-size:14px;
}
.current-turn {
    border:2px solid gold;
}

#playersArea {
    display:flex;
    flex-wrap:wrap;
}

#timer {
    font-size:20px;
    font-weight:bold;
    color:yellow;
}
</style>
</head>

<body>

<!-- LOBBY -->
<div id="lobby" class="screen active">
    <h2>ðŸŽ´ Indian Rummy (6 Players)</h2>
    <input id="name" placeholder="Your Name"><br>
    <button onclick="createRoom()">Create Room</button>
    <input id="roomCode" placeholder="Room Code">
    <button onclick="joinRoom()">Join Room</button>
</div>

<!-- WAITING -->
<div id="waiting" class="screen">
    <h3>Room: <span id="roomDisplay"></span></h3>
    <div id="waitingPlayers"></div>
    <button onclick="startGame()">Start Game</button>
</div>

<!-- GAME -->
<div id="game" class="screen">
    <h3>Room: <span id="gameRoom"></span></h3>
    <div id="timer"></div>

    <div id="playersArea"></div>

    <h4>Discard Pile</h4>
    <div id="discardPile"></div>

    <h4>Your Cards (<span id="cardCount"></span>)</h4>
    <div id="hand"></div>

    <div>
        <button onclick="drawCard('deck')">Draw Deck</button>
        <button onclick="drawCard('discard')">Draw Discard</button>
        <button onclick="discardSelected()">Discard</button>
        <button onclick="createGroup()">Group</button>
        <button onclick="declareShow()">Show</button>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>

const socket = io();
let currentRoom=null;
let myId=null;
let gameState=null;
let selected=[];
let groups=[];
let timerInterval=null;
let timeLeft=45;

/* ========== UI ========== */

function show(id){
    document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
    document.getElementById(id).classList.add("active");
}

/* ========== ROOM ========== */

function createRoom(){
    const name=document.getElementById("name").value;
    socket.emit("createRoom",{playerName:name});
}

function joinRoom(){
    const name=document.getElementById("name").value;
    const code=document.getElementById("roomCode").value;
    socket.emit("joinRoom",{playerName:name,roomCode:code});
}

function startGame(){
    socket.emit("startGame",{roomCode:currentRoom});
}

/* ========== TIMER ========== */

function startTimer(){
    clearInterval(timerInterval);
    timeLeft=45;
    document.getElementById("timer").innerText="Time: 45";
    timerInterval=setInterval(()=>{
        timeLeft--;
        document.getElementById("timer").innerText="Time: "+timeLeft;
        if(timeLeft<=0){
            clearInterval(timerInterval);
        }
    },1000);
}

/* ========== GAME ACTIONS ========== */

function drawCard(source){
    socket.emit("drawCard",{roomCode:currentRoom,source});
}

function discardSelected(){
    if(selected.length!==1){
        alert("Select exactly 1 card");
        return;
    }
    socket.emit("discardCard",{
        roomCode:currentRoom,
        cardId:selected[0]
    });
    selected=[];
}

function createGroup(){
    if(selected.length<3){
        alert("Select minimum 3 cards");
        return;
    }
    groups.push([...selected]);
    selected=[];
    render();
}

function declareShow(){
    const groupedCards=[];
    groups.forEach(g=>{
        groupedCards.push(
            g.map(id=>gameState.hand.find(c=>c.id===id))
        );
    });

    const groupedIds = groups.flat();
    const ungrouped = gameState.hand.filter(
        c=>!groupedIds.includes(c.id)
    );

    socket.emit("declareWin",{
        roomCode:currentRoom,
        groups:groupedCards,
        ungrouped
    });
}

/* ========== RENDER ========== */

function render(){

    if(!gameState) return;

    /* Players */
    const area=document.getElementById("playersArea");
    area.innerHTML="";
    gameState.players.forEach(p=>{
        const div=document.createElement("div");
        div.className="player-box";
        if(p.id===gameState.currentTurn)
            div.classList.add("current-turn");

        div.innerHTML=`
            <div>${p.name}</div>
            <div>Cards: ${p.cardCount}</div>
            <div>Score: ${p.totalScore}</div>
        `;
        area.appendChild(div);
    });

    /* Discard */
    const discard=document.getElementById("discardPile");
    discard.innerHTML="";
    const top=gameState.discardPile.slice(-1)[0];
    if(top){
        discard.innerHTML=`${top.value} ${top.suit}`;
    }

    /* Hand */
    const hand=document.getElementById("hand");
    hand.innerHTML="";
    gameState.hand.forEach(card=>{
        const div=document.createElement("div");
        div.className="card";
        if(card.suit==="â™¥"||card.suit==="â™¦")
            div.classList.add("red");
        if(selected.includes(card.id))
            div.classList.add("selected");

        div.innerHTML=`${card.value}<br>${card.suit}`;

        div.onclick=()=>{
            if(selected.includes(card.id))
                selected=selected.filter(id=>id!==card.id);
            else
                selected.push(card.id);
            render();
        };

        hand.appendChild(div);
    });

    document.getElementById("cardCount").innerText=gameState.hand.length;
}

/* ========== SOCKET ========== */

socket.on("roomCreated",data=>{
    currentRoom=data.roomCode;
    myId=socket.id;
    document.getElementById("roomDisplay").innerText=currentRoom;
    show("waiting");
});

socket.on("roomUpdate",room=>{
    const div=document.getElementById("waitingPlayers");
    div.innerHTML="";
    room.players.forEach(p=>{
        div.innerHTML+=`<div>${p.name}</div>`;
    });
});

socket.on("gameState",state=>{
    gameState=state;
    render();
});

socket.on("timerStarted",()=>{
    startTimer();
});

socket.on("roundWon",data=>{
    alert("Winner: "+data.winner);
});

socket.on("wrongShow",data=>{
    alert("Wrong Show by "+data.player);
});

socket.on("gameWon",data=>{
    alert("Game Winner: "+data.winner);
});

socket.on("error",msg=>{
    alert(msg);
});

</script>

</body>
</html>
